# 智能客服自动回复插件

## 📖 功能介绍

本插件为 XBoard 提供智能客服自动回复功能，支持：

1. **关键词自动回复** - 基于预设关键词规则自动回复常见问题
2. **AI 智能回复** - 集成 OpenAI GPT 模型，智能理解并回复用户问题
3. **转人工处理** - 识别用户转人工请求，自动通知管理员
4. **异步处理** - 所有回复处理均通过队列异步执行，不阻塞 API 响应

## ✨ 特性

- 🤖 **智能匹配** - 支持模糊匹配和优先级排序
- 🧠 **AI 对话** - 基于 OpenAI GPT，支持上下文理解
- 👨‍💼 **转人工** - 自动识别转人工关键词，支持 Telegram 通知
- ⚙️ **灵活配置** - 丰富的配置选项，满足不同需求
- 📊 **日志记录** - 完整的操作日志，便于问题追踪
- ⏱️ **模拟延迟** - 回复前延迟，模拟真实人工回复
- 🚀 **异步处理** - 队列化处理，不阻塞 API，提升系统性能

## 🚀 快速开始

### 1. 安装插件

将插件放置在 `/plugins` 目录下，然后在管理后台启用插件。

### 2. 基础配置

#### 启用关键词回复

1. 在插件配置中启用"启用关键词回复"
2. 配置关键词规则（JSON 格式）：

```json
{
  "如何购买": "您可以通过以下步骤购买：\n1. 注册账号\n2. 选择套餐\n3. 完成支付\n\n如需帮助，请回复'转人工'联系客服。",
  "如何使用": "使用步骤：\n1. 获取订阅链接\n2. 下载客户端\n3. 导入订阅\n\n详细教程请访问知识库。",
  "忘记密码": "请使用邮箱重置密码：\n1. 访问登录页面\n2. 点击'忘记密码'\n3. 按照邮件提示操作"
}
```

#### 启用 AI 回复（可选）

1. 获取 OpenAI API Key
2. 在插件配置中启用"启用AI回复"
3. 配置 API Key 和相关参数：
   - **API Key**: 您的 OpenAI API 密钥
   - **API Base URL**: 默认为 `https://api.openai.com/v1`，可配置为代理地址
   - **AI 模型**: 推荐 `gpt-4o` 或 `DeepSeek`
   - **AI 创造性**: 0-1 之间，建议 0.7
   - **最大长度**: 建议 500 tokens

#### 配置转人工

1. 设置转人工关键词（多个用逗号分隔）：
   ```
   转人工,人工客服,联系客服,人工服务
   ```

2. 启用 Telegram 通知（可选）

## ⚙️ 配置说明

### 基础功能配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| enable_keyword_reply | 布尔 | true | 启用关键词回复 |
| enable_ai_reply | 布尔 | false | 启用 AI 回复 |
| transfer_keywords | 文本 | 转人工,人工客服... | 转人工关键词 |
| keyword_rules | JSON | {...} | 关键词回复规则 |

### AI 配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| ai_api_key | 字符串 | - | OpenAI API Key |
| ai_api_base | 字符串 | https://api.openai.com/v1 | API 基础 URL |
| ai_model | 字符串 | gpt-3.5-turbo | 使用的 AI 模型 |
| ai_temperature | 数字 | 0.7 | AI 创造性（0-1） |
| ai_max_tokens | 数字 | 500 | 最大回复长度 |
| ai_system_prompt | 文本 | 你是... | AI 系统提示词 |
| max_conversation_history | 数字 | 5 | 对话历史数量 |
| enable_user_context | 布尔 | true | 启用用户上下文注入 ⭐ NEW |

**⭐ 用户上下文注入功能**：
- 自动在 AI 提示词中注入用户的实时信息
- 包括：套餐、流量使用情况、余额、佣金、到期时间等
- AI 可基于用户实际情况提供个性化建议
- 例如：用户询问"流量不够"时，AI 会根据实际剩余流量和余额给出针对性建议

### 行为配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| auto_reply_delay | 数字 | 2 | 自动回复延迟（秒） |
| enable_auto_close | 布尔 | false | AI 回复后自动关闭工单 |
| auto_reply_prefix | 字符串 | [自动回复] | 关键词回复前缀 |
| ai_reply_prefix | 字符串 | [AI助手] | AI 回复前缀 |
| enable_telegram_notify | 布尔 | true | 转人工时通知 |

## 🔧 工作原理

### 回复流程

```
用户提交工单/回复
    ↓
任务分发到队列（异步，立即返回）
    ↓
队列处理器执行
    ↓
检查是否包含转人工关键词
    ↓ 是
转人工（发送通知）
    ↓ 否
尝试关键词匹配
    ↓ 匹配成功
发送关键词回复
    ↓ 匹配失败
尝试 AI 回复（如果启用）
    ↓ AI 回复成功
发送 AI 回复
    ↓ 失败或未启用
不自动回复（等待人工）
```

### 异步处理架构

插件采用 Laravel Queue 系统实现异步处理：

1. **即时响应** - 工单创建/回复立即返回，不等待处理完成
2. **队列处理** - 自动回复任务放入 `auto_reply` 队列
3. **失败重试** - 最多重试 2 次，间隔 30 秒
4. **超时控制** - 单个任务最长执行 60 秒

**队列配置（推荐）**：

使用独立的队列处理器处理自动回复任务，简单高效：

```bash
# 使用 queue:work（推荐）
php artisan queue:work --queue=auto_reply
```

**🔧 配置守护进程（Supervisor）**

在宝塔面板中添加进程守护，按以下格式配置：

- **名称**: auto_reply
- **运行用户**: www
- **运行目录**: 网站目录
- **启动命令**: php artisan queue:work --queue=auto_reply
- **进程数量**: 1

**注意**：以下 Horizon 配置与本配置互斥，请根据实际情况选择其中一种。

**🔧 高级配置：使用 Horizon**

如果项目使用 Horizon 管理队列，可以配置在 Horizon 中运行：

1. 修改 `config/horizon.php`，添加 `auto_reply` 队列：

```php
'environments' => [
    'local' => [  // 或 'production'
        'Xboard' => [
            'queue' => [
                'order_handle',
                'traffic_fetch',
                'stat',
                'send_email',
                'send_email_mass',
                'send_telegram',
                'online_sync',
                'auto_reply'  // ← 添加这一行
            ],
        ],
    ],
],
```

2. 重启 Horizon：

```bash
php artisan horizon:terminate
php artisan horizon
```

### 优先级

1. **转人工检测** - 最高优先级
2. **关键词匹配** - 次优先级
3. **AI 回复** - 兜底方案

### 关键词匹配规则

- 支持模糊匹配（不区分大小写）
- 按关键词长度降序匹配（优先匹配长关键词）
- 一个消息只匹配一次

## 💡 最佳实践

### 1. 关键词规则设计

**推荐做法**：

```json
{
  "如何购买套餐": "详细的购买指南...",
  "购买": "简短的购买说明...",
  "忘记密码怎么办": "详细的密码重置步骤...",
  "密码": "简短的密码说明..."
}
```

**避免**：
- 关键词过短（如"是"、"好"）
- 关键词重叠（系统会匹配最长的）
- 回复内容过长（建议 200 字以内）

### 2. AI 提示词优化

**示例提示词**：

```
你是 XBoard VPN 服务的专业客服助手。请遵循以下原则：

1. 礼貌、专业、简洁
2. 优先解答用户问题
3. 无法确定答案时，建议用户回复"转人工"
4. 不要编造信息
5. 回复长度控制在 200 字以内

服务信息：
- 提供全球节点
- 支持多种客户端
- 24/7 人工客服

如果用户问题涉及账号安全、支付问题或投诉，请务必建议转人工处理。
```

### 3. 合理设置延迟

- **短延迟（1-2秒）**：快速响应，但可能显得机械
- **中延迟（2-4秒）**：平衡体验，推荐
- **长延迟（5秒+）**：接近真人，但响应慢

### 4. 监控和优化

定期查看日志，了解：
- 哪些关键词被频繁触发
- 哪些问题 AI 无法回答
- 用户何时请求转人工

根据数据优化关键词规则和 AI 提示词。

## 🐛 故障排查

### AI 回复不工作

1. 检查 API Key 是否正确配置
2. 检查 API Base URL 是否可访问
3. 查看日志中的错误信息
4. 验证账户余额是否充足

### 关键词不匹配

1. 检查 JSON 格式是否正确
2. 确认关键词使用中文或英文
3. 查看日志确认匹配过程

### Telegram 通知不发送

1. 确认已启用 Telegram 通知
2. 检查 Telegram Bot 配置
3. 验证管理员已绑定 Telegram

## 📊 日志说明

插件会记录以下操作日志：

- `关键词匹配成功` - 成功匹配到关键词
- `AI回复成功` - AI 成功生成回复
- `自动回复已发送` - 回复已发送给用户
- `工单转人工处理` - 用户请求转人工
- `AutoReply Plugin Error` - 插件运行错误

查看日志：`storage/logs/laravel.log`

## 🔒 安全说明

1. **API Key 保护**：请妥善保管 OpenAI API Key，不要泄露给他人
2. **内容审核**：AI 回复内容可能不准确，建议定期审查
3. **成本控制**：设置合理的 max_tokens 限制 API 调用成本
4. **隐私保护**：用户对话内容会发送到 OpenAI，请确保符合隐私政策

## 🆕 更新日志

### v1.0.0 (2026-01-18)

- ✨ 首次发布
- 🤖 支持关键词自动回复
- 🧠 集成 OpenAI GPT 智能回复
- 👨‍💼 支持转人工处理
- 📱 支持 Telegram 通知
- 📊 完善的日志记录

## 📝 许可证

本插件仅供个人学习和使用。

**允许**：
- ✅ 个人非商业使用
- ✅ 修改源代码
- ✅ 学习和研究

**禁止**：
- ❌ 商业贩卖
- ❌ 二次售卖
- ❌ 未经授权的商业分发
- ❌ 移除或修改版权声明

## 💬 支持

本项目为免费插件，无法提供太多的人工技术支持，如果有 BUG 和建议请在 GitHub 提交 Issue。

如有问题，请：
1. 查看日志文件
2. 查阅本文档
3. 提交 Issue 到 GitHub

## 🔗 相关链接

- **GitHub 项目**: https://github.com/yuzaimala/Xboard-Plugins
- **Telegram 群组**: https://t.me/malaTheme
- **Telegram 频道**: https://t.me/malatheme_log

---

**开发者**: Mala Theme Team
**版本**: v1.0.0
**更新日期**: 2026-01-18
